# Voice Diary App - システム構成ドキュメント

## システム概要

Voice Diary Appは、音声による感情記録と可視化を提供するモバイルアプリケーションです。最先端の機械学習技術を活用した音声感情分析により、ユーザーの日々の感情状態を定量化し、週次グラフで可視化します。

### 主要機能

- **音声録音**: 最大60秒の音声日記録音
- **AI感情分析**: openSMILEとXGBoostを使用した高精度な感情分析（精度78%）
- **データ可視化**: 週次感情グラフによる感情トレンドの可視化
- **プッシュ通知**: 毎日20:00 JSTの定期通知による習慣化サポート
- **セキュアな認証**: Firebase Authenticationによる安全なユーザー管理

### システム特性

- **プラットフォーム**: iOS、Android（Flutterによるマルチプラットフォーム対応）
- **アーキテクチャ**: マイクロサービスアーキテクチャ
- **クラウド基盤**: Google Cloud Platform + Firebase
- **スケーラビリティ**: サーバーレスアーキテクチャによる自動スケーリング

---

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント層                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │           Flutter Mobile App (iOS/Android)             │   │
│  │                                                         │   │
│  │    • 状態管理: Riverpod                                  │   │
│  │    • ルーティング: GoRouter                              │   │
│  │    • グラフ描画: fl_chart                                │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↕ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                      Firebase Services                          │
│                                                                 │
│    • Firebase Authentication  （ユーザー認証）                  │
│    • Cloud Firestore         （データベース）                   │
│    • Firebase Storage        （音声ファイル保存）               │
│    • Firebase Cloud Messaging（プッシュ通知）                   │
└─────────────────────────────────────────────────────────────────┘
                              ↕ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                  Google Cloud Platform                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    Cloud Run                             │  │
│  │  ┌────────────────────────────────────────────────────┐ │  │
│  │  │  Flask API (Python)                                │ │  │
│  │  │                                                    │ │  │
│  │  │  • REST API エンドポイント                          │ │  │
│  │  │  • Firebase ID Token認証                           │ │  │
│  │  │  • 音声感情分析エンジン                             │ │  │
│  │  │                                                    │ │  │
│  │  │  ┌──────────────────────────────────────────┐     │ │  │
│  │  │  │  AI/MLモデル                              │     │ │  │
│  │  │  │  • openSMILE（音声特徴量抽出）            │     │ │  │
│  │  │  │  • XGBoost Classifier（精度: 78%）       │     │ │  │
│  │  │  │  • XGBoost Regressor（RMSE: 0.077）      │     │ │  │
│  │  │  └──────────────────────────────────────────┘     │ │  │
│  │  └────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  • Cloud Build     （コンテナイメージビルド）                    │
│  • Cloud Scheduler （定期実行・通知スケジューリング）             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 技術スタック

### フロントエンド

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| **フレームワーク** | Flutter 3.8+ | クロスプラットフォームUI開発 |
| **言語** | Dart 3.x+ | プログラミング言語 |
| **状態管理** | Riverpod | リアクティブな状態管理 |
| **グラフ描画** | fl_chart | 感情グラフの可視化 |

### バックエンド

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| **フレームワーク** | Flask | REST API実装 |
| **言語** | Python 3.x | プログラミング言語 |
| **機械学習** | XGBoost | 感情分類・回帰モデル |
| **音声処理** | openSMILE | 音声特徴量抽出 |
| **コンテナ** | Docker | アプリケーションコンテナ化 |

### クラウドサービス

| サービス | 用途 |
|---------|------|
| **Firebase Authentication** | ユーザー認証 |
| **Cloud Firestore** | NoSQLデータベース |
| **Firebase Storage** | 音声ファイル保存 |
| **Cloud Run** | サーバーレスAPI実行環境 |
| **Cloud Build** | CI/CD |

---

## データフロー

### 1. ユーザー認証フロー

```
┌──────────┐         ┌──────────────┐         ┌──────────────┐
│  Mobile  │         │   Firebase   │         │  Firestore   │
│   App    │         │     Auth     │         │              │
└────┬─────┘         └──────┬───────┘         └──────┬───────┘
     │                      │                        │
     │ ① ログイン/登録       │                        │
     ├──────────────────────>│                        │
     │                      │                        │
     │ ② ID Token発行       │                        │
     │<──────────────────────┤                        │
     │                      │                        │
     │ ③ ユーザー情報保存                               │
     ├────────────────────────────────────────────────>│
     │                      │                        │
     │ ④ 認証完了                                      │
     │<────────────────────────────────────────────────┤
```

### 2. 音声録音・感情分析フロー

```
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│  Mobile  │  │ Firebase │  │ Cloud Run│  │ Firebase │  │ Firestore│
│   App    │  │ Storage  │  │   API    │  │ Storage  │  │          │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │             │
     │ ① 音声録音   │             │             │             │
     │   (最大60秒)│             │             │             │
     │             │             │             │             │
     │ ② 音声       │             │             │             │
     │   アップロード│             │             │             │
     ├─────────────>│             │             │             │
     │             │             │             │             │
     │ ③ 感情分析リクエスト          │             │             │
     ├─────────────────────────────>│             │             │
     │             │             │             │             │
     │             │             │ ④ 音声取得  │             │
     │             │             ├─────────────>│             │
     │             │             │             │             │
     │             │             │ ⑤ AI分析実行 │             │
     │             │             │   (3-5秒)   │             │
     │             │             │             │             │
     │             │             │ ⑥ 結果保存                 │
     │             │             ├─────────────────────────────>│
     │             │             │             │             │
     │ ⑦ 分析結果返却               │             │             │
     │<─────────────────────────────┤             │             │
     │  (スコア、カテゴリ)           │             │             │
```

**分析処理の詳細:**
- **音声特徴量抽出**: openSMILEで6,373次元の特徴量を抽出
- **AI予測**: XGBoost Classifier（カテゴリ）+ XGBoost Regressor（強度）
- **スコア算出**: -1.0〜1.0の範囲で正規化

### 3. データ可視化フロー

```
┌──────────┐         ┌──────────────┐         ┌──────────────┐
│  Mobile  │         │   Cloud Run  │         │  Firestore   │
│   App    │         │     API      │         │              │
└────┬─────┘         └──────┬───────┘         └──────┬───────┘
     │                      │                        │
     │ ① 週次データ         │                        │
     │    リクエスト         │                        │
     ├──────────────────────>│                        │
     │                      │                        │
     │                      │ ② データ取得            │
     │                      ├───────────────────────>│
     │                      │                        │
     │                      │ ③ 週次データ           │
     │                      │<───────────────────────┤
     │                      │                        │
     │ ④ 感情データ         │                        │
     │   (JSON形式)         │                        │
     │<──────────────────────┤                        │
     │                      │                        │
     │ ⑤ グラフ描画         │                        │
     │   (fl_chart)         │                        │
```

### 4. プッシュ通知フロー（予定）

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│    Cloud     │    │   Firebase   │    │    Mobile    │
│  Scheduler   │    │   Messaging  │    │     App      │
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘
       │                   │                   │
       │ ① 20:00 JST      │                   │
       │    トリガー         │                   │
       ├──────────────────>│                   │
       │                   │                   │
       │                   │ ② プッシュ通知     │
       │                   ├──────────────────>│
       │                   │                   │
       │                   │                   │ ③ ユーザーに
       │                   │                   │    通知表示
```

---

## 主要機能

### 1. 音声録音機能

- **録音時間**: 最大60秒
- **音声フォーマット**: m4a（AAC, 44.1kHz, 96kbps）
- **ユーザビリティ**: ワンタップで録音開始、リアルタイムカウントダウン表示

### 2. AI感情分析

#### 分析フロー

```
音声録音 → 特徴量抽出 → AI予測 → スコア算出 → データベース保存
```

#### 出力結果

- **感情カテゴリ**: positive（ポジティブ）/ neutral（ニュートラル）/ negative（ネガティブ）
- **感情スコア**: -1.0（最もネガティブ）〜 +1.0（最もポジティブ）
- **処理時間**: 平均3〜5秒

### 3. データ可視化

- **週次グラフ**: 月曜日〜日曜日の感情スコアを折れ線グラフで表示
- **色分け表示**: 感情カテゴリごとに色分け（緑：ポジティブ、灰色：ニュートラル、赤：ネガティブ）
- **トレンド分析**: 感情パターンの把握と変化の可視化

### 4. プッシュ通知

- **定期通知**: 毎日20:00 JSTに録音リマインダーを送信
- **習慣化サポート**: 継続的な記録をサポート

---

## 機械学習モデル

### モデル概要

Voice Diary Appでは、音声から感情を分析するために、2つのXGBoost（勾配ブースティング）モデルを使用しています。

| モデル | 用途 | 性能指標 |
|--------|------|---------|
| **XGBoost Classifier** | 感情カテゴリ分類 | 精度: 78% |
| **XGBoost Regressor** | 感情強度予測 | RMSE: 0.077 |

### 音声特徴量抽出

**openSMILE ComParE_2016**を使用し、6,373次元の音声特徴量を抽出します。

抽出される特徴量の種類：
- **韻律特徴**: ピッチ、音量、話速
- **スペクトル特徴**: MFCC、スペクトル重心
- **音質特徴**: ジッター、シマー
- **時間的特徴**: ポーズの長さ、発話時間

### モデル性能

#### 感情カテゴリ分類（XGBoost Classifier）

テストデータでの性能評価結果：

| クラス | Precision | Recall | F1-score |
|--------|-----------|--------|----------|
| **negative** | 0.89 | 0.78 | 0.83 |
| **neutral** | 0.73 | 0.56 | 0.63 |
| **positive** | 0.73 | 0.89 | 0.80 |
| **総合精度** | - | - | **0.78** |

#### 感情強度予測（XGBoost Regressor）

- **RMSE**: 0.0768（-5.0〜5.0の範囲において高い予測精度）

### 選定理由

GridSearchCVによるハイパーパラメータ最適化の結果、XGBoostが最も高い性能を示しました。XGBoostは以下の利点があります：

- 高い予測精度と汎用性
- 過学習の抑制
- 高速な学習と推論

---